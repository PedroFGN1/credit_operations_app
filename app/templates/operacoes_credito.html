<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operações de Crédito</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    <!-- jQuery e DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/(\d)(?=(\d{3})+\,)/g, '$1.');
            input.value = 'R$ ' + value;
        }

        function prepareForm() {
            const input = document.getElementById('requisitado');
            const hiddenInput = document.getElementById('requisitado_hidden');
            let value = input.value.replace(/[^\d,]/g, '').replace(',', '.');
            hiddenInput.value = parseFloat(value).toFixed(2);
        }
    </script>
</head>
<body class="flex flex-col min-h-screen bg-gray-100">

    <div class="mb-4 shadow-sm border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="default-styled-tab" data-tabs-toggle="#default-styled-tab-content" data-tabs-active-classes="text-[#009e3c] hover:text-[#009e3c] border-green-600" data-tabs-inactive-classes="text-gray-500 hover:text-gray-600 border-gray-100 hover:border-gray-300" role="tablist">
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg" id="profile-styled-tab" data-tabs-target="#styled-profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Simulador</button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg" id="estoque-styled-tab" data-tabs-target="#styled-estoque" type="button" role="tab" aria-controls="estoque" aria-selected="false">Regra de Estoque</button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg" id="contragarantia-styled-tab" data-tabs-target="#styled-contragarantia" type="button" role="tab" aria-controls="contragarantia" aria-selected="false">Regra de Contra-garantias</button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="dashboard-styled-tab" data-tabs-target="#styled-dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">Regras das operações</button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="settings-styled-tab" data-tabs-target="#styled-settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Importar arquivos</button>
            </li>
            <li role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="contacts-styled-tab" data-tabs-target="#styled-contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false">Dados das Operações</button>
            </li>
        </ul>
    </div>
    <div id="default-styled-tab-content">

        <!-- Seção de Simulação -->
        <section class="hidden bg-white mt-8 rounded-xl border shadow-sm" id="styled-profile" role="tabpanel" aria-labelledby="profile-tab">
            <div x-data="{ 
                requisitado: {{ requisitado if requisitado else 0 }},
                mostrarBarra: (localStorage.getItem('mostrarBarra') === 'true' && {{ requisitado if requisitado else 0 }} > 0) 
                }" 
                x-init="$watch('mostrarBarra', value => localStorage.setItem('mostrarBarra', value))" class="container px-6 py-6 mx-auto my-2">
                <div class="hidden items-center justify-center">
                    <a href="/"><button class="px-6 py-2 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">Atualizar Operações</button></a>
                </div>
                <!-- Formulário de Simulação -->
                <form action="{{ url_for('operation_bp.operacoes_de_credito') }}" method="GET" class="flex flex-col justify-start sm:grid sm:grid-cols-2 xl:grid-cols-3 gap-3 mb-6" onsubmit="prepareForm()">
                    
                    <!-- Seletor de Ano com Botão de Filtro -->
                    <div class="flex items-center justify-center gap-4">
                        <!--Select de Ano-->
                        <div class="px-auto flex flex-col items-start justify-center">
                            <label for="ano" class="block font-medium text-sm text-gray-500">Selecione o ano:</label>
                            <span class="absolute">
                                <img src="https://img.icons8.com/?size=100&id=15640&format=png&color=000000" alt="money--v1" class="w-7 h-7 mr-3 ml-2 pt-1 text-gray-400"/>
                            </span>
                            <select id="ano" name="ano" class="mt-2 pl-11 block w-48 font-semibold placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white pr-3 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" required>
                                {% for ano_item in anos %}
                                    <option class="font-semibold"  value="{{ ano_item }}" {% if ano_item == ano %}selected{% endif %}>
                                        {{ ano_item }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-2 text-xs text-gray-400">Lorem ipsum dolor.</p>
                        </div>
                        <!--Botão de Filtro-->
                        <button @click="if (requisitado > 0) mostrarBarra = true" type="submit" class="px-6 py-2 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">
                            filtrar
                        </button>
                    </div>
                    
                    <!-- Campo de Valor Requisitado e Botão de Simular -->
                    <div class="flex items-center justify-center gap-4">
                        <!--Campo de Valor Requisitado-->
                        <div class="px-auto flex flex-col items-start justify-center">
                            <label for="requisitado" class="col-start-1 block font-medium text-sm text-gray-500">Valor a contratar:</label>
                            <span class="absolute">
                                <img src="https://img.icons8.com/?size=100&id=yUTNKgUuTlsA&format=png&color=000000" alt="money--v1" class="w-7 h-7 mr-3 ml-2 text-gray-400"/>
                            </span>
                            <input id="requisitado" type="text" name="requisitado_formatted" placeholder=" R$ 0,00" class="mt-2 block w-auto grow placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white px-10 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" oninput="formatCurrency(this)" />
                            <input id="requisitado_hidden" type="hidden" name="requisitado" />
                            <p class="mt-2 text-xs text-gray-400">Digite aqui o valor da operação desejada.</p>
                        </div>
                        <!--Botão de Simular-->
                        <button @click="if (requisitado > 0) mostrarBarra = true" type="submit" class="px-6 py-2 w-40 font-medium text-white capitalize transition-colors duration-300 transform bg-[#009e3c] rounded-lg hover:bg-white hover:border hover:border-[#009e3c] hover:text-[#009e3c] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">
                            Simular
                        </button>
                    </div>

                    <table class="table-auto my-12 mx-8 sm:col-span-2 xl:col-span-1">
                        <thead>
                            <tr>
                            <th></th>
                            <th></th>
                            </tr>
                        </thead>
                        <tbody class="border-y-2">
                            <tr>
                            <td class="font-medium text-center text-blue-900">Máximo disponível</td>
                            <td class="text-center text-red-600 font-medium">R$ &nbsp;&nbsp;{{ (dados_barra.limite - tabela[1].operacao_credito) | separador_milhar}}</td>
                            </tr>
                        </tbody>
                    </table>
                </form>
                
                <!-- Tabelas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8">

                    <!-- Tabela de Valores do Banco de dados para Regra 1 -->
                    <table class="w-full border-collapse border border-gray-300 rounded-2xl text-sm text-gray-700">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-gray-400 px-4 py-2 text-center">{{ ano-1 }}</th>
                                <th class="border border-gray-400 px-4 py-2 text-center capitalize">regra 1</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rows = [
                                { "text": "amortizações", "value": tabela[0].amortizacao },
                                { "text": "inversões", "value": tabela[0].inversao },
                                { "text": "investimentos", "value": tabela[0].investimento },
                                { "text": "operações de crédito liberadas", "value": tabela[0].operacao_credito },
                                { "text": "despesas de capital", "value": tabela[0].despesas_capital }  
                                ] %}
                            {% for row in rows %}
                            <tr class="hover:bg-gray-100">
                                <td class="border border-gray-400 px-4 py-2 font-semibold capitalize text-start">{{ row.text }}</td>
                                <td class="border border-gray-400 px-4 py-2 font-medium text-end">R$ {{ row.value | separador_milhar }}</td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="2" class="border border-{{tabela[0].bg | replace('bg-','')}} px-4 py-2 text-white font-medium text-center capitalize {{ tabela[0].bg }} ">Nova {{ tabela[0].situacao }}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Tabela de Valores do Banco de dados para Regra 2 -->
                    <table class="w-full border-collapse border rounded-xl border-gray-300 text-sm text-gray-700">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-gray-400 px-4 py-2 text-center">{{ ano }}</th>
                                <th class="border border-gray-400 px-4 py-2 text-center capitalize">regra 2</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rows = [
                                { "text": "amortizações", "value": tabela[1].amortizacao },
                                { "text": "inversões", "value": tabela[1].inversao },
                                { "text": "investimentos", "value": tabela[1].investimento },
                                { "text": "operações de crédito a liberar", "value": tabela[1].operacao_credito },
                                { "text": "despesas de capital", "value": tabela[1].despesas_capital },
                                { "text": "limite de operações", "value": tabela[1].limiteOp }
                                ] %}
                            {% for row in rows %}
                            <tr class="hover:bg-gray-100">
                                <td class="border border-gray-400 px-4 py-2 font-semibold capitalize text-start">{{ row.text }}</td>
                                <td class="border border-gray-400 px-4 py-2 font-medium text-end">R$ {{ row.value | separador_milhar }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table> 

                </div>
                
                <!-- Tabela RCL e Barra de Progresso -->
                <div class="w-full px-2 sm:px-10">

                    <!-- Tabelas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8">

                        <!-- Tabela Valor Total RCL-->
                        <table class="w-full border border-gray-300 rounded-2xl text-sm font-normal text-slate-700">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="border border-gray-400 px-4 py-2 text-center font-bold">Valor RCL de {{ ano }}</th>
                                    <th class="border border-gray-400 px-4 py-2 text-center font-semibold">R$ {{ rcl | separador_milhar  }}</th>
                                </tr>
                            </thead>
                        </table>
                        
                        <!-- Tabela Limite de 16% da RCL -->
                        <table class="w-full border-collapse border rounded-xl border-gray-300 text-sm text-gray-700">
                            <thead class="bg-green-100 ">
                                <tr>
                                    <th class="border border-gray-400 px-4 py-2 text-center">Limite de 16% da RCL de {{ ano }}</th>
                                    <th class="border border-gray-400 px-4 py-2 text-center font-semibold">R$ {{ ( rcl*0.16 ) | separador_milhar}}</th>
                                </tr>
                            </thead>
                        </table> 
                    </div>

                    <!-- Mensagem de erro se requisitado for zero -->
                    <p x-show="requisitado == 0" class="text-red-500 text-sm mt-2">*Insira um valor maior que zero para simular.</p>

                    <!-- Título da Barra de Progresso -->
                    <div x-show="mostrarBarra && requisitado > 0" x-transition.opacity class="mt-4 relative">
                        <h3 class="capitalize text-center text-[#0056a0] font-serif text-lg">
                            limite de operações previsto
                        </h3>
                    </div>

                    <!-- Barra de progresso dinâmica -->
                    <div x-show="mostrarBarra && requisitado > 0" x-transition.opacity
                        class="relative h-5 w-full bg-green-400 rounded-lg overflow-hidden mt-4">
                        <div class="absolute h-full bg-red-500 hover:bg-red-300" 
                            style="width: {{ dados_barra.largura_liberar }}%;"></div>
                        <div class="absolute h-full bg-blue-500 hover:bg-blue-300" 
                            style="left: {{ dados_barra.largura_liberar }}%; width: {{ dados_barra.largura_contratar }}%;"></div>
                    </div>

                    <!-- Legenda -->
                    <div x-show="mostrarBarra && requisitado > 0" x-transition.opacity class="mt-4 flex flex-col md:flex-row justify-center text-base md:gap-6 gap-3">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-red-500 inline-block mr-1 rounded"></span> Operações a Liberar ({{ tabela[1].operacao_credito | separador_milhar }})
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-blue-500 inline-block mr-1 rounded"></span> Operação Requisitada ({{ requisitado | separador_milhar }})
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 inline-block mr-1 rounded"></span> Limite Disponível ({{ (dados_barra.limite - (tabela[1].operacao_credito + requisitado )) | separador_milhar }})
                        </div>
                    </div>

                    {% if apuracao.resultado == "Operação de crédito negada!" %}
                    <div x-show="mostrarBarra && requisitado > 0" class="flex p-4 my-4 text-red-800 border border-red-300 rounded-lg bg-red-50" role="alert">
                            <svg class="shrink-0 inline w-4 h-4 me-3 mt-[2px]" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                            </svg>
                            <span class="sr-only">Info</span>
                            <div>
                            <span class="font-medium capitalize">{{ apuracao.resultado }}</span> &emsp;Valor da operação de crédito excedeu o permitido.<br>
                            
                            <ul class="mt-2 list-disc list-inside">
                                <span class="font-normal">Regras violadas:</span>
                                {% for apuracao in apuracao.violacoes %}
                                <li class="my-1">
                                   {{ apuracao }}
                                </li>
                                {% endfor %}
                            </ul>
                            </div>
                        </div>
                    {% endif %}
                    
            </div>
        </section>
    
        <!-- Seção de Estoque -->
        <section class="hidden bg-white mt-8 rounded-xl border shadow-sm" id="styled-estoque" role="tabpanel" aria-labelledby="estoque-tab">
            <div x-data="{ 
                requisitado: {{ requisitado if requisitado else 0 }},
                mostrarBarra: (localStorage.getItem('mostrarBarra') === 'true' && {{ requisitado if requisitado else 0 }} > 0) 
                }" 
                x-init="$watch('mostrarBarra', value => localStorage.setItem('mostrarBarra', value))" class="container px-6 py-6 mx-auto my-2">
                <div class="hidden items-center justify-center">
                    <a href="/"><button class="px-6 py-2 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">Atualizar Operações</button></a>
                </div>
                <!-- Formulário de Simulação -->
                <form action="{{ url_for('operation_bp.operacoes_de_credito') }}" method="GET" class="flex flex-col justify-start sm:grid sm:grid-cols-2 xl:grid-cols-3 gap-3 mb-6" onsubmit="prepareForm()">
                    
                    <!-- Seletor de Ano com Botão de Filtro -->
                    <div class="flex items-center justify-center gap-4">
                        <!--Select de Ano-->
                        <div class="px-auto flex flex-col items-start justify-center">
                            <label for="ano" class="block font-medium text-sm text-gray-500">Selecione o ano:</label>
                            <span class="absolute">
                                <img src="https://img.icons8.com/?size=100&id=15640&format=png&color=000000" alt="money--v1" class="w-7 h-7 mr-3 mt-5 ml-2 pt-1 text-gray-400"/>
                            </span>
                            <select id="ano" name="ano" class="mt-2 pl-11 block w-48 font-semibold placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white pr-3 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" required>
                                {% for ano_item in anos %}
                                    <option class="font-semibold"  value="{{ ano_item }}" {% if ano_item == ano %}selected{% endif %}>
                                        {{ ano_item }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <!--Botão de Filtro-->
                        <button @click="if (requisitado > 0) mostrarBarra = true" type="submit" class="px-6 py-2 mt-6 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">
                            filtrar
                        </button>
                    </div>
                </form>
                
                <!-- Tabelas -->
                <div class="my-8">
                    
                    <!-- Tabela de Valores do Banco de dados para Regra 2 -->
                    <table class="w-full rounded-xltext-sm text-gray-700">
                        <thead class="">
                            <tr>
                                <th colspan="2" class="px-4 py-2 text-center text-lg text-[#009e3c] capitalize">Regra de Estoque {{ ano }}</th>
                            </tr>
                        </thead>
                        <tbody class="">
                            {% set rows = [
                                { "text": "Dívida Consolidada Líquida", "value": dcl_rgf },
                                { "text": "Receita corrente Líquida Ajustada x2", "value": rcl_rgf*2 },
                                { "text": "Limite de Endividamento", "value": rcl_rgf*2-dcl_rgf},
                                ] %}
                            {% for row in rows %}
                            <tr class="hover:bg-gray-100 border border-gray-400">
                                <td class="border border-gray-400 px-4 py-2 font-semibold text-start">{{ row.text }}</td>
                                <td class="border border-gray-400 px-4 py-2 font-medium text-end">R$ {{ row.value | separador_milhar }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table> 

                </div>
            
                    
            </div>
        </section>

        <!-- Seção de Contra-garantia -->
        <section class="hidden bg-white mt-8 rounded-xl border shadow-sm" id="styled-contragarantia" role="tabpanel" aria-labelledby="contragarantia-tab">
            <div class="container px-6 py-6 mx-auto my-2">
                <div class="hidden items-center justify-center">
                    <a href="/"><button class="px-6 py-2 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">Atualizar Operações</button></a>
                </div>
                <!-- Formulário de Simulação -->
                <form action="{{ url_for('operation_bp.operacoes_de_credito') }}" method="GET" class="flex flex-col justify-start sm:grid sm:grid-cols-2 xl:grid-cols-3 gap-3 mb-6" onsubmit="prepareForm()">
                    
                    <!-- Seletor de Ano com Botão de Filtro -->
                    <div class="flex items-center justify-center gap-4">
                        <!--Select de Ano-->
                        <div class="px-auto flex flex-col items-start justify-center">
                            <label for="ano" class="block font-medium text-sm text-gray-500">Selecione o ano:</label>
                            <span class="absolute">
                                <img src="https://img.icons8.com/?size=100&id=15640&format=png&color=000000" alt="money--v1" class="w-7 h-7 mr-3 mt-5 ml-2 pt-1 text-gray-400"/>
                            </span>
                            <select id="ano" name="ano" class="mt-2 pl-11 block w-48 font-semibold placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white pr-3 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" required>
                                {% for ano_item in anos %}
                                    <option class="font-semibold"  value="{{ ano_item }}" {% if ano_item == ano %}selected{% endif %}>
                                        {{ ano_item }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <!--Botão de Filtro-->
                        <button type="submit" class="px-6 py-2 mt-6 w-30 font-medium text-white capitalize transition-colors duration-300 transform bg-[#0056a0] rounded-lg hover:bg-white hover:border hover:border-[#0056a0] hover:text-[#0056a0] focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80 cursor-pointer">
                            filtrar
                        </button>
                    </div>
                </form>
                
                <!-- Tabelas -->
                <div class="my-8">
                    
                    <!-- Tabela de Valores do Banco de dados para Regra 2 -->
                    <table class="w-full rounded-xl  text-sm text-gray-700">
                        <thead class="">
                            <tr>
                                <th colspan="2" class="px-4 py-2 text-center text-lg text-[#009e3c] capitalize">Regra de Contra-garantia {{ ano }}</th>
                            </tr>
                        </thead>
                        <tbody class="border border-gray-400">
                            {% set rows = [
                                { "text": "Receitas Próprias", "value": receitas_proprias },
                                { "text": "Despesas com Serviço da Dívida", "value": dsd },
                                ] %}
                            {% for row in rows %}
                            <tr class="hover:bg-gray-100">
                                <td class="border border-gray-400 px-4 py-2 font-semibold text-start">{{ row.text }}</td>
                                <td class="border border-gray-400 px-4 py-2 font-medium text-end">R$ {{ row.value | separador_milhar }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table> 

                </div>
            
                    
            </div>
        </section>

        <!-- Seção de Regras -->
        <section class="hidden bg-white mt-4 rounded-xl border shadow-sm" id="styled-dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
            <h1 class="text-2xl m-5 font-semibold text-[#009e3c] capitalize lg:text-3xl">
                Regras para Cálculo das Operações
            </h1>

            <div class="container px-6 py-6 mx-auto">
                
                <h2 class="mb-5 text-lg font-semibold text-[#0056a0] lg:text-2xl">
                    Regra de Fluxo
                </h2>

                <!-- Tabela -->
                <div class="overflow-x-auto mt-2">
                    <table class="w-full border-collapse border rounded-xl border-gray-300 text-sm text-gray-700">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-gray-400 px-4 py-2 text-start">Prazo de validade das informações</th>
                                <th class="border border-gray-400 px-4 py-2 text-blue-500">270 dias</th>
                                <th class="border border-gray-400 px-4 py-2 text-blue-500">180 dias</th>
                                <th class="border border-gray-400 px-4 py-2 text-blue-500">90 dias</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-gray-400 px-4 py-2 font-bold hover:bg-gray-200">Limite de 16%</td>
                                <td class="border border-gray-400 px-4 py-2 font-semibold text-center text-green-600 hover:bg-gray-200">MGA/RCL &lt; 12,80%</td>
                                <td class="border border-gray-400 px-4 py-2 font-semibold text-center text-green-600 hover:bg-gray-200">12,80% ≤ MGA/RCL ≤ 14,40%</td>
                                <td class="border border-gray-400 px-4 py-2 font-semibold text-center text-green-600 hover:bg-gray-200">MGA/RCL &gt; 14,40%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <!-- Quadros de Regras -->
                <div class="grid grid-cols-1 gap-8 my-8 xl:gap-12 md:grid-cols-2">
        
                    <!-- Regra de Ouro 1 -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200  bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra de Ouro 1</h2>
                        <p class="mt-3 text-gray-600">
                            Comparação da receita de operações de crédito com gastos "AMORTIZAÇÕES", "INVERSÕES", "INVESTIMENTOS" do ano anterior.
                        </p>
                    </div>
        
                    <!-- Regra de Ouro 2 -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra de Ouro 2</h2>
                        <p class="mt-3 text-gray-600">
                            Mesmo funcionamento da Regra 1, mas com valores de Gastos e Receitas sempre atualizados por ser do ano atual.
                        </p>
                    </div>
        
                    <!-- Regra 3 -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra 3</h2>
                        <p class="mt-3 text-gray-600">
                            Definição da MGA:<br>
                            Somatório de Operações a entrar do ano e posterior ao mesmo.
                        </p>
                    </div>
        
                    <!-- Regra 4 -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra 4</h2>
                        <p class="mt-3 text-gray-600">
                            Determinação dos prazos das informações, conforme a Tabela.
                        </p>
                    </div>

                </div>

            </div>

            <!-- Seção de Regras de Estoque -->
            <div class="container px-6 py-6 mx-auto">
        
                <h2 class="text-lg font-semibold text-[#0056a0] lg:text-2xl">
                    Regras de Estoque
                </h2>
        
                <!-- Quadros de Regras -->
                <div class="grid grid-cols-1 gap-8 my-8 xl:gap-12 md:grid-cols-2">
        
                    <!-- Regras de Estoque -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200  bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra 1</h2>
                        <p class="mt-3 text-gray-600">
                            A Dívida Consolidada Líquida não pode ser superior a 2 vezes a Receita Corrente Líquida Ajustada.
                        </p>
                    </div>

                    <!-- Regras de  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700">Regra 2</h2>
                        <p class="mt-3 text-gray-600">
                            Os valores da DCL e da RCL ajustada para cálculo dos limites de endividamento devem ser preenchidos pelo último RREO exigível.
                        </p>
                    </div>
        
                    <!-- DCL  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700 hover:text-[#0056a0]">Dívida Consolidada Líquida de {{ano}}</h2>
                        <p class="mt-3 text-gray-600 hover:text-[#009e3c]">
                           R$ {{ dcl_rgf | separador_milhar }}
                        </p>
                    </div>

                    <!-- RCL Ajustada  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="text-xl font-medium text-gray-700 hover:text-[#0056a0]">Receita Corrente Líquida Ajustada de {{ano}}</h2>
                        <p class="mt-3 text-gray-600 hover:text-[#009e3c]">
                            R$ {{ rcl_rgf | separador_milhar }}
                        </p>
                    </div>

                </div>
            </div>

            <!-- Seção de Regras de Contra-Garantia -->
            <div class="container px-6 py-6 mx-auto">
        
                <h2 class="text-lg font-semibold text-[#0056a0] lg:text-2xl">
                    Regras de Contra-Garantias
                </h2>
        
                <!-- Quadros de Regras -->
                <div class="grid grid-cols-1 gap-8 my-8 xl:gap-12 md:grid-cols-2">
                    
                    <div class="flex justify-center items-center col-span-2">
                        <img src="https://www.in.gov.br/documents/68942/530584600/515%2B2023-12-14%2B21229670-1_MF_14_07.jpg/04632ffa-6b3e-62b5-a037-98ab8ae6562b" alt="Fórmula de Margem de Contra-Garantias" class="max-h-56">
                    </div>

                    <!-- RP -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="italic text-xl font-medium text-gray-700">RP</h2>
                        <p class="mt-3 text-gray-600">
                            Corresponde ao somatório das receitas próprias dos Estados, do Distrito Federal e dos Municípios considerados no cálculo.
                        </p>
                    </div>

                    <!-- RT -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="italic text-xl font-medium text-gray-700">RT</h2>
                        <p class="mt-3 text-gray-600">
                            Corresponde ao somatório das receitas constitucionais destinadas a Estados, Distrito Federal e Municípios considerados no cálculo.
                        </p>
                    </div>

                    <!-- DSD  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="italic text-xl font-medium text-gray-700">DSD</h2>
                        <p class="mt-3 text-gray-600">
                            Corresponde ao total de despesas com serviço da dívida.
                        </p>
                    </div>
                    
                    <!-- TCL  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="italic text-xl font-medium text-gray-700">TCL</h2>
                        <p class="mt-3 text-gray-600">
                            Corresponde ao total de despesas com transferências constitucionais e legais, no caso dos Estados.
                        </p>
                    </div>

                    <!-- Receitas Próprias  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="capitalize text-xl font-medium text-gray-700 hover:text-[#0056a0]">somatório de receitas próprias de {{ano}}</h2>
                        <p class="mt-3 text-gray-600 hover:text-[#009e3c]">
                           R$ {{ receitas_proprias | separador_milhar }}
                        </p>
                    </div>

                    <!--  -->
                    <div class="p-6 border rounded-xl hover:shadow-md border-gray-200 bg-gray-50">
                        <h2 class="capitalize text-xl font-medium text-gray-700 hover:text-[#0056a0]">despesas com serviço da dívida de {{ano}}</h2>
                        <p class="mt-3 text-gray-600 hover:text-[#009e3c]">
                            R$ {{ dsd | separador_milhar }}
                        </p>
                    </div>

                </div>
            </div>
        </section>
    
        <!-- Seção de Upload -->
        <section class="hidden p-4 rounded-lg bg-gray-50" id="styled-settings" role="tabpanel" aria-labelledby="settings-tab">
            {% include 'upload_operacoes.html'%}
        </section>

        <!-- Seção de Dados -->
        <section class="hidden bg-white shadow-lg rounded-lg p-6" id="styled-contacts" role="tabpanel" aria-labelledby="contacts-tab">
            <div class="mb-4">
                <a href="{{ url_for('operation_bp.atualizar_operacoes_rreo', status='now') }}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Atualizar Dados do Ano Atual
                </a>
                <a href="{{ url_for('operation_bp.atualizar_operacoes_rreo', status='past') }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-700 ml-2">
                    Atualizar Dados Anteriores
                </a>
                <form id="formFiltroRREO" method="GET" class="mt-4">
                    <div class="px-auto flex flex-col items-start justify-center">
                        <label for="ano" class="block font-medium text-sm text-gray-500">Selecione o ano:</label>
                        <span class="absolute">
                            <img src="https://img.icons8.com/?size=100&id=15640&format=png&color=000000" alt="money--v1" class="w-7 h-7 mt-6 mr-3 ml-2 text-gray-400"/>
                        </span>
                        <select id="anoSelectRREO" name="ano" class="mt-2 pl-11 block w-48 font-semibold placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white pr-3 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" required>
                            {% for ano_item in anos %}
                                <option class="font-semibold"  value="{{ ano_item }}" {% if ano_item == ano %}selected{% endif %}>
                                    {{ ano_item }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>    
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Consulta de Operações</h2>
                
            <!-- Tabela Responsiva -->
            <div class="overflow-x-auto">
                <table id="tabelaOperacoes" class="w-full table-auto border-collapse border border-gray-300 text-sm text-gray-700">
                    <thead class="bg-blue-100">
                        <tr>
                            <th class="border border-gray-400 px-4 py-2">ID</th>
                            <th class="border border-gray-400 px-4 py-2">Ano</th>
                            <th class="border border-gray-400 px-4 py-2">Bimestre</th>
                            <th class="border border-gray-400 px-4 py-2">Anexo</th>
                            <th class="border border-gray-400 px-4 py-2">Movimentação Contábil</th>
                            <th class="border border-gray-400 px-4 py-2">Natureza</th>
                            <th class="border border-gray-400 px-4 py-2">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão carregados via AJAX -->
                    </tbody>
                </table>
            </div>

            <div class="w-full max-w-3xl min-[400px]:max-w-7xl mx-auto my-12 border-b border-solid border-opacity-30 border-gray-400 rounded-lg"></div>

            <div class="my-8">
                <a href="{{ url_for('operation_bp.atualizar_operacoes_rgf', status='now') }}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Atualizar Dados do Ano Atual
                </a>
                <a href="{{ url_for('operation_bp.atualizar_operacoes_rgf', status='past') }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-700 ml-2">
                    Atualizar Dados Anteriores
                </a>
                <form id="formFiltroRGF" method="GET" class="mt-4">
                    <div class="px-auto flex flex-col items-start justify-center">
                        <label for="ano" class="block font-medium text-sm text-gray-500">Selecione o ano:</label>
                        <span class="absolute">
                            <img src="https://img.icons8.com/?size=100&id=15640&format=png&color=000000" alt="money--v1" class="w-7 h-7 mt-6 mr-3 ml-2 text-gray-400"/>
                        </span>
                        <select id="anoSelectRGF" name="ano" class="mt-2 pl-11 block w-48 font-semibold placeholder-gray-400/70 rounded-lg border border-gray-200 bg-white pr-3 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" required>
                            {% for ano_item in anos %}
                                <option class="font-semibold"  value="{{ ano_item }}" {% if ano_item == ano %}selected{% endif %}>
                                    {{ ano_item }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>    
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Consulta de RGF</h2>
                
            <!-- Tabela Responsiva -->
            <div class="overflow-x-auto">
                <table id="tabelaRGF" class="w-full table-auto border-collapse border border-gray-300 text-sm text-gray-700">
                    <thead class="bg-blue-100">
                        <tr>
                            <th class="border border-gray-400 px-4 py-2">ID</th>
                            <th class="border border-gray-400 px-4 py-2">Ano</th>
                            <th class="border border-gray-400 px-4 py-2">Quadrimestre</th>
                            <th class="border border-gray-400 px-4 py-2">Anexo</th>
                            <th class="border border-gray-400 px-4 py-2">Movimentação Contábil</th>
                            <th class="border border-gray-400 px-4 py-2">Natureza</th>
                            <th class="border border-gray-400 px-4 py-2">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão carregados via AJAX -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>
    
    <script>
        $(document).ready(function() {
            var table = $('#tabelaOperacoes').DataTable({
                "ajax": {
                    "url": "/dados_rreo",
                    "data": function(d) {
                        d.ano = $('#anoSelectRREO').val();
                    }
                },
                "columns": [
                    { "data": "id" },
                    { "data": "exercicio" },
                    { "data": "periodo" },
                    { "data": "anexo" },
                    { "data": "coluna" },
                    { "data": "conta" },
                    { "data": "valor" }
                ],
                "columnDefs": [
                { "width": "5%", "targets": 0 },  // ID menor
                { "width": "10%", "targets": 1 }, // Ano
                { "width": "5%", "targets": 2 }, // Bimestre
                { "width": "15%", "targets": 3 }, // anexo
                { "width": "25%", "targets": 4 }, // Movimentação Contábil maior
                { "width": "25%", "targets": 5 }, // Natureza maior
                { "width": "15%", "targets": 6 },  // Valor
                ],
                "autoWidth": false, // Desativa ajuste automático de largura
                "language": {
                    "url": "/static/javascript/pt_br.json"
                },
                "paging": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "dom": 'Bfrtip',
                "buttons": [
                    'copy', 'csv', 'excel', 'pdf'
                ]
            });

            // Captura o evento de mudança do select
            $('#anoSelectRREO').change(function() {
                table.ajax.reload();
            });
        });

            // Captura o evento de submit do formulário
            $('#formFiltroRREO').submit(function(event) {
                event.preventDefault(); // Impede o comportamento padrão de submit

                // Obtém o ano selecionado
                var anoSelecionado = $('#anoSelectRREO').val();

                // Atualiza os dados da tabela com o novo ano
                table.ajax.url("/dados_rreo?ano=" + anoSelecionado).load();
            });
    </script>

    <script>
        $(document).ready(function() {
            var table = $('#tabelaRGF').DataTable({
                "ajax": {
                    "url": "/dados_rgf",
                    "data": function(d) {
                        d.ano = $('#anoSelectRGF').val();
                    }
                },
                "columns": [
                    { "data": "id" },
                    { "data": "exercicio" },
                    { "data": "periodo" },
                    { "data": "anexo" },
                    { "data": "coluna" },
                    { "data": "conta" },
                    { "data": "valor" }
                ],
                "columnDefs": [
                { "width": "5%", "targets": 0 },  // ID menor
                { "width": "10%", "targets": 1 }, // Ano
                { "width": "5%", "targets": 2 }, // Bimestre
                { "width": "15%", "targets": 3 }, // anexo
                { "width": "25%", "targets": 4 }, // Movimentação Contábil maior
                { "width": "25%", "targets": 5 }, // Natureza maior
                { "width": "15%", "targets": 6 },  // Valor
                ],
                "autoWidth": false, // Desativa ajuste automático de largura
                "language": {
                    "url": "/static/javascript/pt_br.json"
                },
                "paging": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "dom": 'Bfrtip',
                "buttons": [
                    'copy', 'csv', 'excel', 'pdf'
                ]
            });

            // Captura o evento de mudança do select
            $('#anoSelectRGF').change(function() {
                table.ajax.reload();
            });
        });

            // Captura o evento de submit do formulário
            $('#formFiltroRGF').submit(function(event) {
                event.preventDefault(); // Impede o comportamento padrão de submit

                // Obtém o ano selecionado
                var anoSelecionado = $('#anoSelectRGF').val();

                // Atualiza os dados da tabela com o novo ano
                table.ajax.url("/dados_rgf?ano=" + anoSelecionado).load();
            });
    </script>

    <footer class="bg-white shadow-md p-4 mt-6 dark:bg-gray-900 dark:border-t dark:border-white">
        <div class="container mx-auto text-center text-gray-600 text-sm dark:text-white">
            &copy; 2025 Sistema de Gerenciamento de Dados da Dívida Pública - Todos os direitos reservados.
        </div>
    </footer>
</body>
</html>
